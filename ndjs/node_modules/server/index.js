var http = require("http");
var path = require("path");
var fs = require("fs");
var url = require("url");

var root = path.resolve(process.argv[2] || ".");
console.log("root is :" + root);
var server = http.createServer((request,response)=>{
    var pathName = url.parse(request.url).pathname;
    var filePath = path.join(root,pathName);
    console.log("request:" + request.method + " " + request.url);
    fs.stat(filePath,(err,stats)=>{
        if(!err && stats.isFile()){
            response.writeHead(200);
            fs.createReadStream(filePath).pipe(response);
        }
        else if(!err && stats.isDirectory()){
            fs.readdir(filePath,(err,files)=>{
                if(err){
                    response404(response);
                }
                else{
                    files.forEach(item=>{
                        if(item == "result.txt"){
                            response.writeHead(200);
                            fs.createReadStream(path.join(filePath,item)).pipe(response);
                        }
                    });
                }
            });
            
        }
        else{
            response404(response);
        }
        
    });
    var response404 = (response) => {
        response.writeHead(404);
        response.end("404");
    };
    // response.writeHead(200,{"content-type":"text/html"});
    // response.end("<h1>hello</h1>");
});
server.listen(8080);